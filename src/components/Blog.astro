---
// src/components/Blog.astro
const allPosts = Object.values(import.meta.glob('../content/**/*.md', { eager: true }));

// Ordenar posts por fecha (más reciente primero)
const sortedPosts = allPosts
  .sort((a: any, b: any) => {
    return new Date(b.frontmatter.pubDate).getTime() - new Date(a.frontmatter.pubDate).getTime();
  });

const postsPerPage = 3;
const totalPages = Math.ceil(sortedPosts.length / postsPerPage);
---

<section id="blog" class="blog-section">
  <div class="container">
    <h2 class="section-title">Blog</h2>
    <p class="section-subtitle">Experiencias y aprendizajes</p>
    
    <div class="blog-grid" id="blogGrid">
      {sortedPosts.slice(0, postsPerPage).map((post: any) => {
        const slug = post.file.split('/').pop()?.replace('.md', '');
        return (
          <article class="blog-card">
            <div class="blog-image">
              <img src={post.frontmatter.image.url} alt={post.frontmatter.image.alt} />
              <div class="blog-category">{post.frontmatter.category}</div>
            </div>
            <div class="blog-content">
              <time class="blog-date">{new Date(post.frontmatter.pubDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
              <h3 class="blog-title">{post.frontmatter.title}</h3>
              <p class="blog-description">{post.frontmatter.description}</p>
              <a href={`/posts/${slug}`} class="blog-link">
                Leer más →
              </a>
            </div>
          </article>
        );
      })}
    </div>

    {totalPages > 1 && (
      <div class="pagination">
        <button class="pagination-btn" id="prevBtn" disabled>
          ← Anterior
        </button>
        <div class="pagination-info">
          <span id="currentPage">1</span> / <span id="totalPages">{totalPages}</span>
        </div>
        <button class="pagination-btn" id="nextBtn">
          Siguiente →
        </button>
      </div>
    )}
  </div>
</section>

<script define:vars={{ sortedPosts, postsPerPage, totalPages }}>
  // Esperar a que el DOM esté listo
  if (typeof window !== 'undefined') {
    let currentPage = 1;
    const allCards = [];
    
    function initBlogPagination() {
      // Guardar todas las tarjetas originales
      sortedPosts.forEach(post => {
        const slug = post.file.split('/').pop()?.replace('.md', '');
        const date = new Date(post.frontmatter.pubDate).toLocaleDateString('es-ES', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        const cardHTML = `
          <article class="blog-card">
            <div class="blog-image">
              <img src="${post.frontmatter.image.url}" alt="${post.frontmatter.image.alt}" loading="lazy" />
              <div class="blog-category">${post.frontmatter.category}</div>
            </div>
            <div class="blog-content">
              <time class="blog-date">${date}</time>
              <h3 class="blog-title">${post.frontmatter.title}</h3>
              <p class="blog-description">${post.frontmatter.description}</p>
              <a href="/posts/${slug}" class="blog-link">
                Leer más →
              </a>
            </div>
          </article>
        `;
        allCards.push(cardHTML);
      });
    }
    
    function updateBlogPagination() {
      const start = (currentPage - 1) * postsPerPage;
      const end = start + postsPerPage;
      const cardsToShow = allCards.slice(start, end);
      
      const blogGrid = document.getElementById('blogGrid');
      if (blogGrid) {
        blogGrid.innerHTML = cardsToShow.join('');
      }
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const currentPageEl = document.getElementById('currentPage');
      
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage === totalPages;
      if (currentPageEl) currentPageEl.textContent = currentPage.toString();
    }
    
    // Inicializar cuando el DOM esté listo
    window.addEventListener('DOMContentLoaded', () => {
      initBlogPagination();
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            updateBlogPagination();
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            updateBlogPagination();
          }
        });
      }
    });
  }
</script>

<style is:global>
  .blog-section {
    padding: 100px 20px;
    background: #0a0a0a;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .section-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #ffffff 0%, #c0c0c0 50%, #808080 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
  }

  .section-subtitle {
    text-align: center;
    color: #888;
    font-size: 1.2rem;
    margin-bottom: 4rem;
  }

  .blog-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .blog-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
  }

  .blog-card:hover {
    transform: translateY(-12px);
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
  }

  .blog-image {
    position: relative;
    height: 250px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.02);
  }

  .blog-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    transition: transform 0.3s ease;
  }

  .blog-card:hover .blog-image img {
    transform: scale(1.1);
  }

  .blog-category {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .blog-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .blog-date {
    display: block;
    color: #888;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .blog-title {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #fff;
    line-height: 1.3;
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .blog-description {
    color: #aaa;
    line-height: 1.6;
    margin-bottom: 1rem;
    flex-grow: 1;
  }

  .blog-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
    padding: 0.5rem 0;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #ffffff 0%, #c0c0c0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .blog-link:hover {
    transform: translateX(8px);
    opacity: 0.8;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-top: 3rem;
  }

  .pagination-btn {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: #fff;
    padding: 0.85rem 1.75rem;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .pagination-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  }

  .pagination-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .pagination-info {
    color: #fff;
    font-size: 1.1rem;
    font-weight: 500;
  }

  @media (max-width: 1024px) {
    .blog-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .blog-grid {
      grid-template-columns: 1fr;
    }

    .section-title {
      font-size: 2rem;
    }

    .pagination {
      gap: 1rem;
    }

    .pagination-btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
  }
</style>